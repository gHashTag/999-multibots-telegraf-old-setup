#!/bin/sh
set -e

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."
pwd
ls -la /app
ls -la /app/dist || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è dist –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
mkdir -p /app/logs
mkdir -p /app/dist/utils
mkdir -p /app/dist/helpers/error
mkdir -p /app/dist/interfaces
mkdir -p /app/dist/core/bot
mkdir -p /app/dist/core/supabase

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–æ–¥—É–ª—è winston..."
if [ ! -d "/app/node_modules/winston" ]; then
  echo "‚ö†Ô∏è –ú–æ–¥—É–ª—å winston –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
  cd /app && npm install winston --save
else
  echo "‚úÖ –ú–æ–¥—É–ª—å winston –Ω–∞–π–¥–µ–Ω."
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ bot.js
if [ ! -f "/app/dist/bot.js" ]; then
  echo "‚ùå –§–∞–π–ª /app/dist/bot.js –Ω–µ –Ω–∞–π–¥–µ–Ω. –í—ã–ø–æ–ª–Ω—è–µ–º —Å–±–æ—Ä–∫—É..."
  cd /app && npm run build
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
  if [ ! -f "/app/dist/bot.js" ]; then
    echo "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª bot.js. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ dist:"
    ls -la /app/dist/
    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ src –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
    ls -la /app/src/
  fi
else
  echo "‚úÖ –§–∞–π–ª /app/dist/bot.js –Ω–∞–π–¥–µ–Ω."
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º node –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
cd /app
ls -la /app/dist
exec "$@" 