#!/bin/bash

# ============================================================================
# üåà –†–ê–î–£–ñ–ù–´–ô –ú–û–°–¢ - –°–ö–†–ò–ü–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ß–ï–†–ï–ó SSH
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ NeuroBlogger –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
# –ê–≤—Ç–æ—Ä: –ù–µ–π—Ä–æ–ö–æ–¥–µ—Ä
# –î–∞—Ç–∞: 20.04.2025
# ============================================================================

# –¶–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
SSH_KEY="~/.ssh/id_rsa"
SERVER="root@999-multibots-u14194.vm.elestio.app"
PROJECT_DIR="/opt/app/999-multibots-telegraf"

# =========================== –§–£–ù–ö–¶–ò–ò ===============================

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—á–∞—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ü–≤–µ—Ç–æ–º
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—á–∞—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
print_header() {
    local message=$1
    echo ""
    print_message "${CYAN}==== üåü ${message} üåü ====${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
check_result() {
    if [ $? -ne 0 ]; then
        print_message "${RED}‚ùå –û—à–∏–±–∫–∞: $1${NC}"
        exit 1
    else
        print_message "${GREEN}‚úÖ –£—Å–ø–µ—à–Ω–æ: $1${NC}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
run_ssh_command() {
    local command=$1
    local message=$2
    
    print_message "${YELLOW}üîÑ –í—ã–ø–æ–ª–Ω—è—é: ${command}${NC}"
    output=$(ssh -i ${SSH_KEY} ${SERVER} "${command}" 2>&1)
    result=$?
    
    if [ $result -ne 0 ]; then
        print_message "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã:${NC}"
        echo "$output"
        print_message "${RED}–û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞.${NC}"
        exit 1
    else
        if [ -n "$message" ]; then
            print_message "${GREEN}‚úÖ $message${NC}"
        fi
        echo "$output"
    fi
    
    return $result
}

# =========================== –û–°–ù–û–í–ù–û–ô –ö–û–î ===============================

print_header "–ù–ê–ß–ê–õ–û –ü–†–û–¶–ï–°–°–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ù–ï–ô–†–û–ë–õ–û–ì–ì–ï–†"
print_message "${PURPLE}üîÆ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: $(date)${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è SSH –∫–ª—é—á–∞
if [ ! -f $(eval echo ${SSH_KEY}) ]; then
    print_message "${RED}‚ùå SSH –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: ${SSH_KEY}${NC}"
    print_message "${YELLOW}‚ÑπÔ∏è –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ SSH –∫–ª—é—á—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
    exit 1
fi

print_message "${GREEN}‚úÖ SSH –∫–ª—é—á –Ω–∞–π–¥–µ–Ω: ${SSH_KEY}${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
print_header "–ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò –°–ï–†–í–ï–†–ê"
run_ssh_command "echo '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!'" "–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
print_header "–ü–†–û–í–ï–†–ö–ê –ù–ê–õ–ò–ß–ò–Ø –ü–†–û–ï–ö–¢–ê"
run_ssh_command "if [ -d ${PROJECT_DIR} ]; then echo '–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞'; else echo '–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'; exit 1; fi" "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
print_header "–ü–†–û–í–ï–†–ö–ê GIT –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø"
run_ssh_command "cd ${PROJECT_DIR} && git status" "Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ –ø–æ—Ä—è–¥–∫–µ"

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
print_header "–°–û–•–†–ê–ù–ï–ù–ò–ï –õ–û–ö–ê–õ–¨–ù–´–• –ò–ó–ú–ï–ù–ï–ù–ò–ô"
run_ssh_command "cd ${PROJECT_DIR} && git stash" "–õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–µ—Å–ª–∏ –±—ã–ª–∏)"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
print_header "–ü–û–õ–£–ß–ï–ù–ò–ï –ü–û–°–õ–ï–î–ù–ò–• –ò–ó–ú–ï–ù–ï–ù–ò–ô"
run_ssh_command "cd ${PROJECT_DIR} && git fetch --all" "–ü–æ–ª—É—á–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
print_header "–ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ü–û–°–õ–ï–î–ù–ò–• –ò–ó–ú–ï–ù–ï–ù–ò–ô"
run_ssh_command "cd ${PROJECT_DIR} && git pull" "–ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏"

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤
print_header "–û–ë–ù–û–í–õ–ï–ù–ò–ï –†–ê–ó–†–ï–®–ï–ù–ò–ô –î–õ–Ø –°–ö–†–ò–ü–¢–û–í"
run_ssh_command "cd ${PROJECT_DIR} && chmod +x scripts/*.sh" "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Docker
print_header "–ó–ê–ü–£–°–ö –û–ë–ù–û–í–õ–ï–ù–ò–Ø DOCKER"
run_ssh_command "cd ${PROJECT_DIR} && ./scripts/update-docker.sh" "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Docker –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
print_header "–ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í"
run_ssh_command "docker ps" "–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–æ–≥–æ–≤
print_header "–ü–û–°–õ–ï–î–ù–ò–ï –õ–û–ì–ò –ö–û–ù–¢–ï–ô–ù–ï–†–û–í"
run_ssh_command "docker logs 999-multibots --tail 10" "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
run_ssh_command "docker logs nginx-proxy --tail 10" "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ Nginx"

print_header "–û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û"
print_message "${PURPLE}üåà –ù–µ–π—Ä–æ–ë–ª–æ–≥–≥–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏!${NC}"
print_message "${BLUE}üìÖ –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)${NC}"
print_message "${GREEN}üíñ –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –†–∞–¥—É–∂–Ω–æ–≥–æ –ú–æ—Å—Ç–∞!${NC}"

exit 0 